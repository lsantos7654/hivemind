# Build System and Configuration

## Build System Type

bazel-lib uses Bazel as both its build system and the target platform it supports. The repository is designed to be consumed through two primary mechanisms:

1. **Bzlmod (Modern)**: MODULE.bazel-based dependency management for Bazel 6.0+
2. **WORKSPACE (Legacy)**: Traditional WORKSPACE file approach for older projects

The project itself is built using Bzlmod with rules_go for compiling native Go tools and Gazelle for managing BUILD files and Go dependencies.

## Configuration Files

### MODULE.bazel
The primary configuration file declaring:
- Module name: `bazel_lib`
- Bazel compatibility: `>=6.0.0`
- Compatibility level: 1 (semantic versioning commitment)
- Direct dependencies with minimum versions:
  - bazel_features 1.9.0
  - bazel_skylib 1.8.1
  - platforms 0.0.10
  - rules_shell 0.4.1

Module extensions configuration:
```starlark
bazel_lib_toolchains = use_extension("@bazel_lib//lib:extensions.bzl", "toolchains")
bazel_lib_toolchains.copy_directory()
bazel_lib_toolchains.copy_to_directory()
bazel_lib_toolchains.coreutils()
bazel_lib_toolchains.zstd()
bazel_lib_toolchains.expand_template()
bazel_lib_toolchains.bats()
```

Dev dependencies (IS_RELEASE flag controls inclusion):
- rules_go 0.59.0
- gazelle 0.40.0
- buildifier_prebuilt 6.4.0

### .bazelrc
Build and test configuration:
- Common flags for build and test commands
- Platform-specific settings
- CI-specific configurations
- Remote execution settings

### .bazelversion
Pins the minimum Bazel version required, ensuring consistent builds across environments.

### go.mod and go.sum
Go module dependencies for native tools:
```
module github.com/bazel-contrib/bazel-lib

go 1.23

require (
    github.com/bmatcuk/doublestar/v4 v4.7.1
    golang.org/x/exp latest
    golang.org/x/sys latest
)
```

### deps.bzl
Auto-generated Go dependencies for WORKSPACE users:
- Maps Go modules to go_repository rules
- Generated by `gazelle update-repos`
- Includes transitive dependencies for tools

### bzl_library.bzl
Custom rule definition extending skylib's bzl_library:
- Adds support for .star files
- Generates starlark_doc_extract validation
- Ensures proper dependency declarations in public APIs

## External Dependencies

### Runtime Dependencies

**bazel_skylib** (1.8.1+)
- Foundation Starlark utilities (sets, dicts, types, selects)
- unittest framework for tests
- Basic rules like write_file, copy_file
- bazel-lib builds upon and extends these

**bazel_features** (1.9.0+)
- Version detection for Bazel features
- Enables version-aware functionality
- Guards against using features not available in older Bazel versions

**platforms** (0.0.10+)
- Standard platform constraint definitions
- Required for platform transition rules
- Host platform detection

**rules_shell** (0.4.1+)
- Shell script support for tests
- Required for bats integration

### Dev Dependencies (Build from Source)

**rules_go** (0.59.0+)
- Compiles Go tools (copy_directory, copy_to_directory, expand_template)
- Only required when not using pre-built releases
- Configured via `go_sdk.from_file(go_mod = "//:go.mod")`

**gazelle** (0.40.0+)
- Generates and maintains BUILD files
- Manages Go dependencies in deps.bzl
- Bazel Skylib plugin for bzl_library generation

**buildifier_prebuilt** (6.4.0+)
- Code formatting and linting
- Integrated via pre-commit hooks
- Used in CI for validation

### Toolchain Dependencies

Toolchains fetch pre-built binaries for supported platforms:

**coreutils_toolchains**
- Hermetic uutils/coreutils (Rust reimplementation)
- Provides cp, mkdir, and other utilities
- Version controlled via DEFAULT_COREUTILS_VERSION

**copy_directory_toolchains**
- Platform-specific copy_directory binaries
- Fetched from GitHub releases or built from tools/copy_directory

**copy_to_directory_toolchains**
- Directory assembly binaries with filtering support
- Supports complex include/exclude patterns

**expand_template_toolchains**
- Fast template expansion binaries
- Alternative to slower Starlark-only implementations

**zstd_toolchains**
- Compression/decompression utilities
- Used by various rules for artifact compression

**bats_toolchains**
- Bash Automated Testing System
- Used for shell script testing in tests

## Build Targets and Commands

### Primary Build Targets

**Gazelle (BUILD file management)**
```bash
# Update BUILD files based on sources
bazel run //:gazelle

# Check if BUILD files are up to date (CI)
bazel run //:gazelle.check

# Update Go dependencies in deps.bzl
bazel run //:gazelle_update_repos
```

**Formatting and Linting**
```bash
# Format all Starlark code
bazel run //:buildifier

# Check formatting (CI)
bazel run //:buildifier_check
```

**Go Tools**
```bash
# Build copy_directory tool
bazel build //tools/copy_directory

# Build copy_to_directory tool
bazel build //tools/copy_to_directory

# Build expand_template tool
bazel build //tools/expand_template

# Build all tools
bazel build //tools/...
```

**Library Rules**
```bash
# Build all bzl_library targets
bazel build //lib:all

# Build specific library
bazel build //lib:copy_file
```

### Testing

**Unit Tests**
```bash
# Run all tests
bazel test //...

# Run lib tests only
bazel test //lib/tests/...

# Run specific test
bazel test //lib/tests:paths_test
```

**Integration Tests**
```bash
# Run e2e tests
bazel test //e2e/...

# Run write_source_files e2e
bazel test //e2e/write_source_files/...
```

**Test with different Bazel versions**
```bash
# Use specific Bazel version
USE_BAZEL_VERSION=6.0.0 bazel test //...
```

### Documentation Validation

```bash
# Validate API documentation dependencies
bazel build //lib:all --keep_going

# Validates starlark_doc_extract for each bzl_library
# Ensures public APIs declare all dependencies
```

### Release Workflow

```bash
# Tag release (triggers GitHub Actions)
git tag -a v3.0.0
git push --tags

# GitHub Actions then:
# 1. Builds all tools for each platform
# 2. Creates release archives
# 3. Publishes to GitHub Releases
# 4. (Manual) Submits to Bazel Central Registry
```

## Building for Development

### As Dependency of Other Rules

Use local_path_override in consuming project:

```starlark
# In consuming project's MODULE.bazel
bazel_dep(name = "bazel_lib", version = "3.0.0")
local_path_override(
    module_name = "bazel_lib",
    path = "../bazel-lib",  # Path to local checkout
)
```

Or use git_override for specific commits:

```starlark
git_override(
    module_name = "bazel_lib",
    commit = "abc123",
    remote = "https://github.com/bazel-contrib/bazel-lib.git",
)
```

For WORKSPACE users:

```python
local_repository(
    name = "bazel_lib",
    path = "../bazel-lib",
)

load("@bazel_lib//:deps.bzl", "go_dependencies")
go_dependencies()
```

### Pre-commit Hooks

Install formatting automation:

```bash
# Requires pre-commit >= v3.2.0
pre-commit install

# Manually run on all files
pre-commit run --all-files
```

Configured checks in `.pre-commit-config.yaml`:
- Buildifier formatting
- Trailing whitespace removal
- End-of-file fixers
- YAML validation

### CI/CD Pipeline

GitHub Actions workflows (`.github/workflows/`):
- **ci.yaml**: Runs tests on all supported platforms
- **release.yaml**: Builds release artifacts
- **bcr-publish.yaml**: Prepares BCR submissions

Platforms tested:
- Linux (x64, arm64)
- macOS (x64, arm64)
- Windows (x64)

## Deployment and Distribution

### Bazel Central Registry (BCR)

Released as optimized module:
- Pre-built Go binaries for all platforms
- Dev dependencies marked as `dev_dependency = True`
- Smaller download size, faster builds
- Automated integrity hash generation

### GitHub Releases

Each release includes:
- Source tarball
- Pre-built binaries for all tools
- SHA256 checksums
- Release notes
- Installation instructions

### Versioning

Follows semantic versioning:
- **Major**: Breaking API changes, incompatible updates
- **Minor**: New features, backward compatible
- **Patch**: Bug fixes, no API changes

Version 3.0 was a major release with:
- Rename from aspect_bazel_lib to bazel_lib
- Split of tar, jq, yq into separate modules
- Can coexist with 2.x for migrations

## Platform Support

Supports all platforms Bazel runs on:
- Linux (x86_64, aarch64)
- macOS (x86_64, arm64)
- Windows (x86_64)

Special Windows considerations:
- Rules work WITHOUT `--enable_runfiles` flag
- Use runfiles libraries for path resolution
- Test data includes symlinks (requires Developer mode or core.symlinks=true)

Cross-compilation supported via platform transitions, enabling builds targeting different platforms from a single host.
